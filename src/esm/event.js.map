{"version":3,"file":"event.js","names":["warn","error","WUJIE_ALL_EVENT","WUJIE_TIPS_NO_SUBJECT","appEventObjMap","window","__POWERED_BY_WUJIE__","__WUJIE","inject","Map","EventBus","id","_classCallCheck","$clear","get","set","eventObj","_createClass","key","value","$on","event","fn","cbs","includes","push","$onAll","$once","on","$off","apply","arguments","bind","length","concat","cb","i","splice","$offAll","$emit","allCbs","forEach","_len","args","Array","_key","l","_cbs","_allCbs","e","_appEventObjMap$get","events","Object","keys"],"sources":["../src/event.ts"],"sourcesContent":["import { warn, error } from \"./utils\";\r\nimport { WUJIE_ALL_EVENT, WUJIE_TIPS_NO_SUBJECT } from \"./constant\";\r\n\r\nexport type EventObj = { [event: string]: Array<Function> };\r\n\r\n// 全部事件存储map\r\nexport const appEventObjMap = window.__POWERED_BY_WUJIE__\r\n  ? window.__WUJIE.inject.appEventObjMap\r\n  : new Map<String, EventObj>();\r\n\r\n// eventBus 事件中心\r\nexport class EventBus {\r\n  private id: string;\r\n  private eventObj: EventObj;\r\n\r\n  constructor(id: string) {\r\n    this.id = id;\r\n    this.$clear();\r\n    if (!appEventObjMap.get(this.id)) {\r\n      appEventObjMap.set(this.id, {});\r\n    }\r\n    this.eventObj = appEventObjMap.get(this.id);\r\n  }\r\n\r\n  // 监听事件\r\n  public $on(event: string, fn: Function): EventBus {\r\n    const cbs = this.eventObj[event];\r\n    if (!cbs) {\r\n      this.eventObj[event] = [fn];\r\n      return this;\r\n    }\r\n    if (!cbs.includes(fn)) cbs.push(fn);\r\n    return this;\r\n  }\r\n\r\n  /** 任何$emit都会导致监听函数触发，第一个参数为事件名，后续的参数为$emit的参数 */\r\n  public $onAll(fn: (event: string, ...args: Array<any>) => any): EventBus {\r\n    return this.$on(WUJIE_ALL_EVENT, fn);\r\n  }\r\n\r\n  // 一次性监听事件\r\n  public $once(event: string, fn: Function): void {\r\n    const on = function (...args: Array<any>) {\r\n      this.$off(event, on);\r\n      fn(...args);\r\n    }.bind(this);\r\n    this.$on(event, on);\r\n  }\r\n\r\n  // 取消监听\r\n  public $off(event: string, fn: Function): EventBus {\r\n    const cbs = this.eventObj[event];\r\n    if (!event || !cbs || !cbs.length) {\r\n      warn(`${event} ${WUJIE_TIPS_NO_SUBJECT}`);\r\n      return this;\r\n    }\r\n\r\n    let cb;\r\n    let i = cbs.length;\r\n    while (i--) {\r\n      cb = cbs[i];\r\n      if (cb === fn) {\r\n        cbs.splice(i, 1);\r\n        break;\r\n      }\r\n    }\r\n    return this;\r\n  }\r\n\r\n  // 取消监听$onAll\r\n  public $offAll(fn: Function): EventBus {\r\n    return this.$off(WUJIE_ALL_EVENT, fn);\r\n  }\r\n\r\n  // 发送事件\r\n  public $emit(event: string, ...args: Array<any>): EventBus {\r\n    let cbs = [];\r\n    let allCbs = [];\r\n\r\n    appEventObjMap.forEach((eventObj) => {\r\n      if (eventObj[event]) cbs = cbs.concat(eventObj[event]);\r\n      if (eventObj[WUJIE_ALL_EVENT]) allCbs = allCbs.concat(eventObj[WUJIE_ALL_EVENT]);\r\n    });\r\n\r\n    if (!event || (cbs.length === 0 && allCbs.length === 0)) {\r\n      warn(`${event} ${WUJIE_TIPS_NO_SUBJECT}`);\r\n    } else {\r\n      try {\r\n        for (let i = 0, l = cbs.length; i < l; i++) cbs[i](...args);\r\n        for (let i = 0, l = allCbs.length; i < l; i++) allCbs[i](event, ...args);\r\n      } catch (e) {\r\n        error(e);\r\n      }\r\n    }\r\n    return this;\r\n  }\r\n\r\n  // 清空当前所有的监听事件\r\n  public $clear(): EventBus {\r\n    const eventObj = appEventObjMap.get(this.id) ?? {};\r\n    const events = Object.keys(eventObj);\r\n    events.forEach((event) => delete eventObj[event]);\r\n    return this;\r\n  }\r\n}\r\n"],"mappings":"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","ignoreList":[]}