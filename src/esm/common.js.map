{"version":3,"file":"common.js","names":["idToSandboxCacheMap","window","__POWERED_BY_WUJIE__","__WUJIE","inject","idToSandboxMap","Map","getWujieById","id","_idToSandboxCacheMap$","get","wujie","getOptionsById","_idToSandboxCacheMap$2","options","addSandboxCacheWithWujie","sandbox","wujieCache","set","_objectSpread","deleteWujieById","addSandboxCacheWithOptions","documentProxyProperties","modifyLocalProperties","modifyProperties","shadowProperties","shadowMethods","documentProperties","documentMethods","documentEvents","ownerProperties","appDocumentAddEventListenerEvents","appDocumentOnEvents","mainDocumentAddEventListenerEvents","mainAndAppAddEventListenerEvents","appWindowAddEventListenerEvents","appWindowOnEvent","relativeElementTagAttrMap","IMG","A","SOURCE","windowProxyProperties","windowRegWhiteList","rawElementAppendChild","HTMLElement","prototype","appendChild","rawElementRemoveChild","removeChild","rawElementContains","contains","rawHeadInsertBefore","HTMLHeadElement","insertBefore","rawBodyInsertBefore","HTMLBodyElement","rawAddEventListener","Node","addEventListener","rawRemoveEventListener","removeEventListener","rawWindowAddEventListener","rawWindowRemoveEventListener","rawAppendChild","rawDocumentQuerySelector","__WUJIE_RAW_DOCUMENT_QUERY_SELECTOR__","Document","querySelector"],"sources":["../src/common.ts"],"sourcesContent":["import Wujie from \"./sandbox\";\r\nimport { cacheOptions } from \"./index\";\r\nexport interface SandboxCache {\r\n  wujie?: Wujie;\r\n  options?: cacheOptions;\r\n}\r\n\r\nexport type appAddEventListenerOptions = AddEventListenerOptions & { targetWindow?: Window };\r\n\r\n// 全部无界实例和配置存储map\r\nexport const idToSandboxCacheMap = window.__POWERED_BY_WUJIE__\r\n  ? window.__WUJIE.inject.idToSandboxMap\r\n  : new Map<String, SandboxCache>();\r\n\r\nexport function getWujieById(id: String): Wujie | null {\r\n  return idToSandboxCacheMap.get(id)?.wujie || null;\r\n}\r\n\r\nexport function getOptionsById(id: String): cacheOptions | null {\r\n  return idToSandboxCacheMap.get(id)?.options || null;\r\n}\r\n\r\nexport function addSandboxCacheWithWujie(id: string, sandbox: Wujie): void {\r\n  const wujieCache = idToSandboxCacheMap.get(id);\r\n  if (wujieCache) idToSandboxCacheMap.set(id, { ...wujieCache, wujie: sandbox });\r\n  else idToSandboxCacheMap.set(id, { wujie: sandbox });\r\n}\r\n\r\nexport function deleteWujieById(id: string) {\r\n  const wujieCache = idToSandboxCacheMap.get(id);\r\n  if (wujieCache?.options) idToSandboxCacheMap.set(id, { options: wujieCache.options });\r\n  idToSandboxCacheMap.delete(id);\r\n}\r\n\r\nexport function addSandboxCacheWithOptions(id: string, options: cacheOptions): void {\r\n  const wujieCache = idToSandboxCacheMap.get(id);\r\n  if (wujieCache) idToSandboxCacheMap.set(id, { ...wujieCache, options });\r\n  else idToSandboxCacheMap.set(id, { options });\r\n}\r\n\r\n// 分类document上需要处理的属性，不同类型会进入不同的处理逻辑\r\nexport const documentProxyProperties = {\r\n  // 降级场景下需要本地特殊处理的属性\r\n  modifyLocalProperties: [\"createElement\", \"createTextNode\", \"documentURI\", \"URL\", \"getElementsByTagName\"],\r\n\r\n  // 子应用需要手动修正的属性方法\r\n  modifyProperties: [\r\n    \"createElement\",\r\n    \"createTextNode\",\r\n    \"documentURI\",\r\n    \"URL\",\r\n    \"getElementsByTagName\",\r\n    \"getElementsByClassName\",\r\n    \"getElementsByName\",\r\n    \"getElementById\",\r\n    \"querySelector\",\r\n    \"querySelectorAll\",\r\n    \"documentElement\",\r\n    \"scrollingElement\",\r\n    \"forms\",\r\n    \"images\",\r\n    \"links\",\r\n  ],\r\n\r\n  // 需要从shadowRoot中获取的属性\r\n  shadowProperties: [\r\n    \"activeElement\",\r\n    \"childElementCount\",\r\n    \"children\",\r\n    \"firstElementChild\",\r\n    \"firstChild\",\r\n    \"fullscreenElement\",\r\n    \"lastElementChild\",\r\n    \"pictureInPictureElement\",\r\n    \"pointerLockElement\",\r\n    \"styleSheets\",\r\n  ],\r\n\r\n  // 需要从shadowRoot中获取的方法\r\n  shadowMethods: [\r\n    \"append\",\r\n    \"contains\",\r\n    \"getSelection\",\r\n    \"elementFromPoint\",\r\n    \"elementsFromPoint\",\r\n    \"getAnimations\",\r\n    \"replaceChildren\",\r\n  ],\r\n\r\n  // 需要从主应用document中获取的属性\r\n  documentProperties: [\r\n    \"characterSet\",\r\n    \"compatMode\",\r\n    \"contentType\",\r\n    \"designMode\",\r\n    \"dir\",\r\n    \"doctype\",\r\n    \"embeds\",\r\n    \"fullscreenEnabled\",\r\n    \"hidden\",\r\n    \"implementation\",\r\n    \"lastModified\",\r\n    \"pictureInPictureEnabled\",\r\n    \"plugins\",\r\n    \"readyState\",\r\n    \"referrer\",\r\n    \"visibilityState\",\r\n    \"fonts\",\r\n  ],\r\n\r\n  // 需要从主应用document中获取的方法\r\n  documentMethods: [\r\n    \"execCommand\",\r\n    \"caretPositionFromPoint\",\r\n    \"createRange\",\r\n    \"exitFullscreen\",\r\n    \"exitPictureInPicture\",\r\n    \"getElementsByTagNameNS\",\r\n    \"hasFocus\",\r\n    \"prepend\",\r\n  ],\r\n\r\n  // 需要从主应用document中获取的事件\r\n  documentEvents: [\r\n    \"onpointerlockchange\",\r\n    \"onpointerlockerror\",\r\n    \"onbeforecopy\",\r\n    \"onbeforecut\",\r\n    \"onbeforepaste\",\r\n    \"onfreeze\",\r\n    \"onresume\",\r\n    \"onsearch\",\r\n    \"onfullscreenchange\",\r\n    \"onfullscreenerror\",\r\n    \"onsecuritypolicyviolation\",\r\n    \"onvisibilitychange\",\r\n  ],\r\n\r\n  // 无需修改原型的属性\r\n  ownerProperties: [\"head\", \"body\"],\r\n};\r\n\r\n// 需要挂载到子应用iframe document上的事件\r\nexport const appDocumentAddEventListenerEvents = [\"DOMContentLoaded\", \"readystatechange\"];\r\nexport const appDocumentOnEvents = [\"onreadystatechange\"];\r\n// 需要挂载到主应用document上的事件\r\nexport const mainDocumentAddEventListenerEvents = [\r\n  \"fullscreenchange\",\r\n  \"fullscreenerror\",\r\n  \"selectionchange\",\r\n  \"visibilitychange\",\r\n  \"wheel\",\r\n  \"keydown\",\r\n  \"keypress\",\r\n  \"keyup\",\r\n];\r\n\r\n// 需要同时挂载到主应用document和shadow上的事件（互斥）\r\nexport const mainAndAppAddEventListenerEvents = [\"gotpointercapture\", \"lostpointercapture\"];\r\n\r\n// 子应用window监听需要挂载到iframe沙箱上的事件\r\nexport const appWindowAddEventListenerEvents = [\r\n  \"hashchange\",\r\n  \"popstate\",\r\n  \"DOMContentLoaded\",\r\n  \"load\",\r\n  \"beforeunload\",\r\n  \"unload\",\r\n  \"message\",\r\n  \"error\",\r\n  \"unhandledrejection\",\r\n];\r\n\r\n// 子应用window.onXXX需要挂载到iframe沙箱上的事件\r\nexport const appWindowOnEvent = [\"onload\", \"onbeforeunload\", \"onunload\"];\r\n\r\n// 相对路径问题元素的tag和attr的map\r\nexport const relativeElementTagAttrMap = {\r\n  IMG: \"src\",\r\n  A: \"href\",\r\n  SOURCE: \"src\",\r\n};\r\n\r\n// 需要单独处理的window属性\r\nexport const windowProxyProperties = [\"getComputedStyle\", \"visualViewport\", \"matchMedia\", \"DOMParser\"];\r\n\r\n// window白名单\r\nexport const windowRegWhiteList = [\r\n  /animationFrame$/i,\r\n  /resizeObserver$|mutationObserver$|intersectionObserver$/i,\r\n  /height$|width$|left$/i,\r\n  /^screen/i,\r\n  /X$|Y$/,\r\n];\r\n\r\n// 保存原型方法\r\n// 子应用的Document.prototype已经被改写了\r\nexport const rawElementAppendChild = HTMLElement.prototype.appendChild;\r\nexport const rawElementRemoveChild = HTMLElement.prototype.removeChild;\r\nexport const rawElementContains = HTMLElement.prototype.contains;\r\nexport const rawHeadInsertBefore = HTMLHeadElement.prototype.insertBefore;\r\nexport const rawBodyInsertBefore = HTMLBodyElement.prototype.insertBefore;\r\nexport const rawAddEventListener = Node.prototype.addEventListener;\r\nexport const rawRemoveEventListener = Node.prototype.removeEventListener;\r\nexport const rawWindowAddEventListener = window.addEventListener;\r\nexport const rawWindowRemoveEventListener = window.removeEventListener;\r\nexport const rawAppendChild = Node.prototype.appendChild;\r\nexport const rawDocumentQuerySelector = window.__POWERED_BY_WUJIE__\r\n  ? window.__WUJIE_RAW_DOCUMENT_QUERY_SELECTOR__\r\n  : Document.prototype.querySelector;\r\n"],"mappings":"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","ignoreList":[]}