{"version":3,"file":"sandbox.js","names":["iframeGenerator","recoverEventListeners","recoverDocumentListeners","insertScriptToIframe","patchEventTimeStamp","syncUrlToWindow","syncUrlToIframe","clearInactiveAppUrl","createWujieWebComponent","clearChild","getPatchStyleElements","renderElementToContainer","renderTemplateToShadowRoot","renderTemplateToIframe","initRenderIframeAndContainer","removeLoading","proxyGenerator","localGenerator","getPlugins","getPresetLoaders","removeEventListener","idToSandboxCacheMap","addSandboxCacheWithWujie","deleteWujieById","rawElementAppendChild","rawDocumentQuerySelector","EventBus","appEventObjMap","isFunction","wujieSupport","appRouteParse","requestIdleCallback","getAbsolutePath","eventTrigger","WUJIE_DATA_ATTACH_CSS_FLAG","Wujie","options","_classCallCheck","_defineProperty","WeakMap","window","__POWERED_BY_WUJIE__","inject","__WUJIE","idToSandboxMap","mainHostPath","location","protocol","host","name","url","attrs","fiber","degradeAttrs","degrade","lifecycles","plugins","id","bus","provide","styleSheetElements","execQueue","_appRouteParse","urlElement","appHostPath","appRoutePath","iframe","_localGenerator","proxyDocument","proxyLocation","_proxyGenerator","proxyWindow","proxy","_createClass","key","value","_active","_asyncToGenerator","_regeneratorRuntime","mark","_callee","_this","sync","el","template","props","alive","prefix","fetch","replace","iframeWindow","iframeFetch","iframeBody","_initRenderIframeAndC","container","_iframeBody","wrap","_callee$","_context","prev","next","hrefFlag","activeFlag","iframeReady","contentWindow","input","init","href","execFlag","call","document","onunload","unmount","contentDocument","replaceChild","documentElement","abrupt","shadowRoot","patchCssRules","stop","active","_x","apply","arguments","callback","_this2","_start","_callee2","getExternalScripts","_this3","scriptResultList","beforeScriptResultList","afterScriptResultList","syncScriptResultList","asyncScriptResultList","deferScriptResultList","domContentLoadedTrigger","domLoadedTrigger","_callee2$","_context2","sent","forEach","scriptResult","defer","push","async","beforeScriptResult","concat","contentPromise","then","content","_objectSpread","mount","_this3$execQueue$shif","shift","afterScriptResult","_this3$execQueue$shif2","__WUJIE_UNMOUNT","Promise","resolve","_this3$execQueue$shif3","start","_x2","_this$execQueue$shift","mountFlag","__WUJIE_MOUNT","_this$lifecycles","_this$lifecycles$befo","_this$lifecycles2","_this$lifecycles2$aft","beforeMount","afterMount","_this$lifecycles3","_this$lifecycles3$act","activated","_this$lifecycles4","_this$lifecycles4$dea","deactivated","_this$lifecycles5","_this$lifecycles5$bef","_this$lifecycles6","_this$lifecycles6$aft","beforeUnmount","afterUnmount","$clear","head","body","destroy","elementEventCacheMap","_this$iframe$parentNo","__WUJIE_EVENTLISTENER__","o","type","listener","parentNode","removeChild","rebuildStyleSheets","_this4","length","styleSheetElement","hasAttribute","_getPatchStyleElement","Array","from","querySelectorAll","map","sheet","_getPatchStyleElement2","_slicedToArray","hostStyleSheetElement","fontStyleSheetElement","appendChild","setAttribute","default"],"sources":["../src/sandbox.ts"],"sourcesContent":["import {\r\n  iframeGenerator,\r\n  recoverEventListeners,\r\n  recoverDocumentListeners,\r\n  insertScriptToIframe,\r\n  patchEventTimeStamp,\r\n} from \"./iframe\";\r\nimport { syncUrlToWindow, syncUrlToIframe, clearInactiveAppUrl } from \"./sync\";\r\nimport {\r\n  createWujieWebComponent,\r\n  clearChild,\r\n  getPatchStyleElements,\r\n  renderElementToContainer,\r\n  renderTemplateToShadowRoot,\r\n  renderTemplateToIframe,\r\n  initRenderIframeAndContainer,\r\n  removeLoading,\r\n} from \"./shadow\";\r\nimport { proxyGenerator, localGenerator } from \"./proxy\";\r\nimport { ScriptResultList } from \"./entry\";\r\nimport { getPlugins, getPresetLoaders } from \"./plugin\";\r\nimport { removeEventListener } from \"./effect\";\r\nimport {\r\n  SandboxCache,\r\n  idToSandboxCacheMap,\r\n  addSandboxCacheWithWujie,\r\n  deleteWujieById,\r\n  rawElementAppendChild,\r\n  rawDocumentQuerySelector,\r\n} from \"./common\";\r\nimport { EventBus, appEventObjMap, EventObj } from \"./event\";\r\nimport { isFunction, wujieSupport, appRouteParse, requestIdleCallback, getAbsolutePath, eventTrigger } from \"./utils\";\r\nimport { WUJIE_DATA_ATTACH_CSS_FLAG } from \"./constant\";\r\nimport { plugin, ScriptObjectLoader, loadErrorHandler } from \"./index\";\r\n\r\nexport type lifecycle = (appWindow: Window) => any;\r\ntype lifecycles = {\r\n  beforeLoad: lifecycle;\r\n  beforeMount: lifecycle;\r\n  afterMount: lifecycle;\r\n  beforeUnmount: lifecycle;\r\n  afterUnmount: lifecycle;\r\n  activated: lifecycle;\r\n  deactivated: lifecycle;\r\n  loadError: loadErrorHandler;\r\n};\r\n/**\r\n * 基于 Proxy和iframe 实现的沙箱\r\n */\r\nexport default class Wujie {\r\n  public id: string;\r\n  /** 激活时路由地址 */\r\n  public url: string;\r\n  /** 子应用保活 */\r\n  public alive: boolean;\r\n  /** window代理 */\r\n  public proxy: WindowProxy;\r\n  /** document代理 */\r\n  public proxyDocument: Object;\r\n  /** location代理 */\r\n  public proxyLocation: Object;\r\n  /** 事件中心 */\r\n  public bus: EventBus;\r\n  /** 容器 */\r\n  public el: HTMLElement;\r\n  /** js沙箱 */\r\n  public iframe: HTMLIFrameElement;\r\n  /** css沙箱 */\r\n  public shadowRoot: ShadowRoot;\r\n  /** 子应用的template */\r\n  public template: string;\r\n  /** 子应用代码替换钩子 */\r\n  public replace: (code: string) => string;\r\n  /** 子应用自定义fetch */\r\n  public fetch: (input: RequestInfo, init?: RequestInit) => Promise<Response>;\r\n  /** 子应用的生命周期 */\r\n  public lifecycles: lifecycles;\r\n  /** 子应用的插件 */\r\n  public plugins: Array<plugin>;\r\n  /** js沙箱ready态 */\r\n  public iframeReady: Promise<void>;\r\n  /** 子应用预加载态 */\r\n  public preload: Promise<void>;\r\n  /** 降级时渲染iframe的属性 */\r\n  public degradeAttrs: { [key: string]: any };\r\n  /** 子应用js执行队列 */\r\n  public execQueue: Array<Function>;\r\n  /** 子应用执行过标志 */\r\n  public execFlag: boolean;\r\n  /** 子应用激活标志 */\r\n  public activeFlag: boolean;\r\n  /** 子应用mount标志 */\r\n  public mountFlag: boolean;\r\n  /** 路由同步标志 */\r\n  public sync: boolean;\r\n  /** 子应用短路径替换，路由同步时生效 */\r\n  public prefix: { [key: string]: string };\r\n  /** 子应用跳转标志 */\r\n  public hrefFlag: boolean;\r\n  /** 子应用采用fiber模式执行 */\r\n  public fiber: boolean;\r\n  /** 子应用降级标志 */\r\n  public degrade: boolean;\r\n  /** 子应用降级document */\r\n  public document: Document;\r\n  /** 子应用styleSheet元素 */\r\n  public styleSheetElements: Array<HTMLLinkElement | HTMLStyleElement>;\r\n  /** 子应用head元素 */\r\n  public head: HTMLHeadElement;\r\n  /** 子应用body元素 */\r\n  public body: HTMLBodyElement;\r\n  /** 自定义沙箱 iframe src */\r\n  public mainHostPath: string;\r\n  /** 子应用dom监听事件留存，当降级时用于保存元素事件 */\r\n  public elementEventCacheMap: WeakMap<\r\n    Node,\r\n    Array<{ type: string; handler: EventListenerOrEventListenerObject; options: any }>\r\n  > = new WeakMap();\r\n\r\n  /** $wujie对象，提供给子应用的接口 */\r\n  public provide: {\r\n    bus: EventBus;\r\n    shadowRoot?: ShadowRoot;\r\n    props?: { [key: string]: any };\r\n    location?: Object;\r\n  };\r\n\r\n  /** 子应用嵌套场景，父应用传递给子应用的数据 */\r\n  public inject: {\r\n    idToSandboxMap: Map<String, SandboxCache>;\r\n    appEventObjMap: Map<String, EventObj>;\r\n    mainHostPath: string;\r\n  };\r\n\r\n  /** 激活子应用\r\n   * 1、同步路由\r\n   * 2、动态修改iframe的fetch\r\n   * 3、准备shadow\r\n   * 4、准备子应用注入\r\n   */\r\n  public async active(options: {\r\n    url: string;\r\n    sync?: boolean;\r\n    prefix?: { [key: string]: string };\r\n    template?: string;\r\n    el?: string | HTMLElement;\r\n    props?: { [key: string]: any };\r\n    alive?: boolean;\r\n    fetch?: (input: RequestInfo, init?: RequestInit) => Promise<Response>;\r\n    replace?: (code: string) => string;\r\n  }): Promise<void> {\r\n    const { sync, url, el, template, props, alive, prefix, fetch, replace } = options;\r\n    this.url = url;\r\n    this.sync = sync;\r\n    this.alive = alive;\r\n    this.hrefFlag = false;\r\n    this.prefix = prefix ?? this.prefix;\r\n    this.replace = replace ?? this.replace;\r\n    this.provide.props = props ?? this.provide.props;\r\n    this.activeFlag = true;\r\n    // wait iframe init\r\n    await this.iframeReady;\r\n\r\n    // 处理子应用自定义fetch\r\n    // TODO fetch检验合法性\r\n    const iframeWindow = this.iframe.contentWindow;\r\n    const iframeFetch = fetch\r\n      ? (input: RequestInfo, init?: RequestInit) =>\r\n          fetch(typeof input === \"string\" ? getAbsolutePath(input, (this.proxyLocation as Location).href) : input, init)\r\n      : this.fetch;\r\n    if (iframeFetch) {\r\n      iframeWindow.fetch = iframeFetch;\r\n      this.fetch = iframeFetch;\r\n    }\r\n\r\n    // 处理子应用路由同步\r\n    if (this.execFlag && this.alive) {\r\n      // 当保活模式下子应用重新激活时，只需要将子应用路径同步回主应用\r\n      syncUrlToWindow(iframeWindow);\r\n    } else {\r\n      // 先将url同步回iframe，然后再同步回浏览器url\r\n      syncUrlToIframe(iframeWindow);\r\n      syncUrlToWindow(iframeWindow);\r\n    }\r\n\r\n    // inject template\r\n    this.template = template ?? this.template;\r\n\r\n    /* 降级处理 */\r\n    if (this.degrade) {\r\n      const iframeBody = rawDocumentQuerySelector.call(iframeWindow.document, \"body\") as HTMLElement;\r\n      const { iframe, container } = initRenderIframeAndContainer(this.id, el ?? iframeBody, this.degradeAttrs);\r\n      this.el = container;\r\n      // 销毁js运行iframe容器内部dom\r\n      if (el) clearChild(iframeBody);\r\n      // 修复vue的event.timeStamp问题\r\n      patchEventTimeStamp(iframe.contentWindow, iframeWindow);\r\n      // 当销毁iframe时主动unmount子应用\r\n      iframe.contentWindow.onunload = () => {\r\n        this.unmount();\r\n      };\r\n      if (this.document) {\r\n        if (this.alive) {\r\n          iframe.contentDocument.replaceChild(this.document.documentElement, iframe.contentDocument.documentElement);\r\n          // 保活场景需要事件全部恢复\r\n          recoverEventListeners(iframe.contentDocument.documentElement, iframeWindow);\r\n        } else {\r\n          await renderTemplateToIframe(iframe.contentDocument, this.iframe.contentWindow, this.template);\r\n          // 非保活场景需要恢复根节点的事件，防止react16监听事件丢失\r\n          recoverDocumentListeners(this.document.documentElement, iframe.contentDocument.documentElement, iframeWindow);\r\n        }\r\n      } else {\r\n        await renderTemplateToIframe(iframe.contentDocument, this.iframe.contentWindow, this.template);\r\n      }\r\n      this.document = iframe.contentDocument;\r\n      return;\r\n    }\r\n\r\n    if (this.shadowRoot) {\r\n      /*\r\n       document.addEventListener was transfer to shadowRoot.addEventListener\r\n       react 16 SyntheticEvent will remember document event for avoid repeat listen\r\n       shadowRoot have to dispatchEvent for react 16 so can't be destroyed\r\n       this may lead memory leak risk\r\n       */\r\n      this.el = renderElementToContainer(this.shadowRoot.host, el);\r\n      if (this.alive) return;\r\n    } else {\r\n      // 预执行无容器，暂时插入iframe内部触发Web Component的connect\r\n      const iframeBody = rawDocumentQuerySelector.call(iframeWindow.document, \"body\") as HTMLElement;\r\n      this.el = renderElementToContainer(createWujieWebComponent(this.id), el ?? iframeBody);\r\n    }\r\n\r\n    await renderTemplateToShadowRoot(this.shadowRoot, iframeWindow, this.template);\r\n    this.patchCssRules();\r\n\r\n    // inject shadowRoot to app\r\n    this.provide.shadowRoot = this.shadowRoot;\r\n  }\r\n\r\n  // 未销毁，空闲时才回调\r\n  public requestIdleCallback(callback) {\r\n    return requestIdleCallback(() => {\r\n      // 假如已经被销毁了\r\n      if (!this.iframe) return;\r\n      callback.apply(this);\r\n    });\r\n  }\r\n  /** 启动子应用\r\n   * 1、运行js\r\n   * 2、处理兼容样式\r\n   */\r\n  public async start(getExternalScripts: () => ScriptResultList): Promise<void> {\r\n    this.execFlag = true;\r\n    // 执行脚本\r\n    const scriptResultList = await getExternalScripts();\r\n    // 假如已经被销毁了\r\n    if (!this.iframe) return;\r\n    const iframeWindow = this.iframe.contentWindow;\r\n    // 标志位，执行代码前设置\r\n    iframeWindow.__POWERED_BY_WUJIE__ = true;\r\n    // 用户自定义代码前\r\n    const beforeScriptResultList: ScriptObjectLoader[] = getPresetLoaders(\"jsBeforeLoaders\", this.plugins);\r\n    // 用户自定义代码后\r\n    const afterScriptResultList: ScriptObjectLoader[] = getPresetLoaders(\"jsAfterLoaders\", this.plugins);\r\n    // 同步代码\r\n    const syncScriptResultList: ScriptResultList = [];\r\n    // async代码无需保证顺序，所以不用放入执行队列\r\n    const asyncScriptResultList: ScriptResultList = [];\r\n    // defer代码需要保证顺序并且DOMContentLoaded前完成，这里统一放置同步脚本后执行\r\n    const deferScriptResultList: ScriptResultList = [];\r\n    scriptResultList.forEach((scriptResult) => {\r\n      if (scriptResult.defer) deferScriptResultList.push(scriptResult);\r\n      else if (scriptResult.async) asyncScriptResultList.push(scriptResult);\r\n      else syncScriptResultList.push(scriptResult);\r\n    });\r\n\r\n    // 插入代码前\r\n    beforeScriptResultList.forEach((beforeScriptResult) => {\r\n      this.execQueue.push(() =>\r\n        this.fiber\r\n          ? this.requestIdleCallback(() => insertScriptToIframe(beforeScriptResult, iframeWindow))\r\n          : insertScriptToIframe(beforeScriptResult, iframeWindow)\r\n      );\r\n    });\r\n\r\n    // 同步代码\r\n    syncScriptResultList.concat(deferScriptResultList).forEach((scriptResult) => {\r\n      this.execQueue.push(() =>\r\n        scriptResult.contentPromise.then((content) =>\r\n          this.fiber\r\n            ? this.requestIdleCallback(() => insertScriptToIframe({ ...scriptResult, content }, iframeWindow))\r\n            : insertScriptToIframe({ ...scriptResult, content }, iframeWindow)\r\n        )\r\n      );\r\n    });\r\n\r\n    // 异步代码\r\n    asyncScriptResultList.forEach((scriptResult) => {\r\n      scriptResult.contentPromise.then((content) => {\r\n        this.fiber\r\n          ? this.requestIdleCallback(() => insertScriptToIframe({ ...scriptResult, content }, iframeWindow))\r\n          : insertScriptToIframe({ ...scriptResult, content }, iframeWindow);\r\n      });\r\n    });\r\n\r\n    //框架主动调用mount方法\r\n    this.execQueue.push(this.fiber ? () => this.requestIdleCallback(() => this.mount()) : () => this.mount());\r\n\r\n    //触发 DOMContentLoaded 事件\r\n    const domContentLoadedTrigger = () => {\r\n      eventTrigger(iframeWindow.document, \"DOMContentLoaded\");\r\n      eventTrigger(iframeWindow, \"DOMContentLoaded\");\r\n      this.execQueue.shift()?.();\r\n    };\r\n    this.execQueue.push(this.fiber ? () => this.requestIdleCallback(domContentLoadedTrigger) : domContentLoadedTrigger);\r\n\r\n    // 插入代码后\r\n    afterScriptResultList.forEach((afterScriptResult) => {\r\n      this.execQueue.push(() =>\r\n        this.fiber\r\n          ? this.requestIdleCallback(() => insertScriptToIframe(afterScriptResult, iframeWindow))\r\n          : insertScriptToIframe(afterScriptResult, iframeWindow)\r\n      );\r\n    });\r\n\r\n    //触发 loaded 事件\r\n    const domLoadedTrigger = () => {\r\n      eventTrigger(iframeWindow.document, \"readystatechange\");\r\n      eventTrigger(iframeWindow, \"load\");\r\n      this.execQueue.shift()?.();\r\n    };\r\n    this.execQueue.push(this.fiber ? () => this.requestIdleCallback(domLoadedTrigger) : domLoadedTrigger);\r\n    // 由于没有办法准确定位是哪个代码做了mount，保活、重建模式提前关闭loading\r\n    if (this.alive || !isFunction(this.iframe.contentWindow.__WUJIE_UNMOUNT)) removeLoading(this.el);\r\n    this.execQueue.shift()();\r\n\r\n    // 所有的execQueue队列执行完毕，start才算结束，保证串行的执行子应用\r\n    return new Promise((resolve) => {\r\n      this.execQueue.push(() => {\r\n        resolve();\r\n        this.execQueue.shift()?.();\r\n      });\r\n    });\r\n  }\r\n\r\n  /**\r\n   * 框架主动发起mount，如果子应用是异步渲染实例，比如将生命周__WUJIE_MOUNT放到async函数内\r\n   * 此时如果采用fiber模式渲染（主应用调用mount的时机也是异步不确定的），框架调用mount时可能\r\n   * 子应用的__WUJIE_MOUNT还没有挂载到window，所以这里封装一个mount函数，当子应用是异步渲染\r\n   * 实例时，子应用异步函数里面最后加上window.__WUJIE.mount()来主动调用\r\n   */\r\n  public mount(): void {\r\n    if (this.mountFlag) return;\r\n    if (isFunction(this.iframe.contentWindow.__WUJIE_MOUNT)) {\r\n      removeLoading(this.el);\r\n      this.lifecycles?.beforeMount?.(this.iframe.contentWindow);\r\n      this.iframe.contentWindow.__WUJIE_MOUNT();\r\n      this.lifecycles?.afterMount?.(this.iframe.contentWindow);\r\n      this.mountFlag = true;\r\n    }\r\n    if (this.alive) {\r\n      this.lifecycles?.activated?.(this.iframe.contentWindow);\r\n    }\r\n    this.execQueue.shift()?.();\r\n  }\r\n\r\n  /** 保活模式和使用proxyLocation.href跳转链接都不应该销毁shadow */\r\n  public unmount(): void {\r\n    this.activeFlag = false;\r\n    // 清理子应用过期的同步参数\r\n    clearInactiveAppUrl();\r\n    if (this.alive) {\r\n      this.lifecycles?.deactivated?.(this.iframe.contentWindow);\r\n    }\r\n    if (!this.mountFlag) return;\r\n    if (isFunction(this.iframe.contentWindow.__WUJIE_UNMOUNT) && !this.alive && !this.hrefFlag) {\r\n      this.lifecycles?.beforeUnmount?.(this.iframe.contentWindow);\r\n      this.iframe.contentWindow.__WUJIE_UNMOUNT();\r\n      this.lifecycles?.afterUnmount?.(this.iframe.contentWindow);\r\n      this.mountFlag = false;\r\n      this.bus.$clear();\r\n      if (!this.degrade) {\r\n        clearChild(this.shadowRoot);\r\n        // head body需要复用，每次都要清空事件\r\n        removeEventListener(this.head);\r\n        removeEventListener(this.body);\r\n      }\r\n      clearChild(this.head);\r\n      clearChild(this.body);\r\n    }\r\n  }\r\n\r\n  /** 销毁子应用 */\r\n  public destroy() {\r\n    this.unmount();\r\n    this.bus.$clear();\r\n    this.shadowRoot = null;\r\n    this.proxy = null;\r\n    this.proxyDocument = null;\r\n    this.proxyLocation = null;\r\n    this.execQueue = null;\r\n    this.provide = null;\r\n    this.degradeAttrs = null;\r\n    this.styleSheetElements = null;\r\n    this.bus = null;\r\n    this.replace = null;\r\n    this.fetch = null;\r\n    this.execFlag = null;\r\n    this.mountFlag = null;\r\n    this.hrefFlag = null;\r\n    this.document = null;\r\n    this.head = null;\r\n    this.body = null;\r\n    this.elementEventCacheMap = null;\r\n    this.lifecycles = null;\r\n    this.plugins = null;\r\n    this.provide = null;\r\n    this.inject = null;\r\n    this.execQueue = null;\r\n    this.prefix = null;\r\n    // 清除 dom\r\n    if (this.el) {\r\n      clearChild(this.el);\r\n      this.el = null;\r\n    }\r\n    // 清除 iframe 沙箱\r\n    if (this.iframe) {\r\n      const iframeWindow = this.iframe.contentWindow;\r\n      if (iframeWindow?.__WUJIE_EVENTLISTENER__) {\r\n        iframeWindow.__WUJIE_EVENTLISTENER__.forEach((o) => {\r\n          iframeWindow.removeEventListener(o.type, o.listener, o.options);\r\n        });\r\n      }\r\n      this.iframe.parentNode?.removeChild(this.iframe);\r\n      this.iframe = null;\r\n    }\r\n    deleteWujieById(this.id);\r\n  }\r\n\r\n  /** 当子应用再次激活后，只运行mount函数，样式需要重新恢复 */\r\n  public rebuildStyleSheets(): void {\r\n    if (this.styleSheetElements && this.styleSheetElements.length) {\r\n      this.styleSheetElements.forEach((styleSheetElement) => {\r\n        rawElementAppendChild.call(this.degrade ? this.document.head : this.shadowRoot.head, styleSheetElement);\r\n      });\r\n    }\r\n    this.patchCssRules();\r\n  }\r\n\r\n  /**\r\n   * 子应用样式打补丁\r\n   * 1、兼容:root选择器样式到:host选择器上\r\n   * 2、将@font-face定义到shadowRoot外部\r\n   */\r\n  public patchCssRules(): void {\r\n    if (this.degrade) return;\r\n    if (this.shadowRoot.host.hasAttribute(WUJIE_DATA_ATTACH_CSS_FLAG)) return;\r\n    const [hostStyleSheetElement, fontStyleSheetElement] = getPatchStyleElements(\r\n      Array.from(this.iframe.contentDocument.querySelectorAll(\"style\")).map(\r\n        (styleSheetElement) => styleSheetElement.sheet\r\n      )\r\n    );\r\n    if (hostStyleSheetElement) {\r\n      this.shadowRoot.head.appendChild(hostStyleSheetElement);\r\n      this.styleSheetElements.push(hostStyleSheetElement);\r\n    }\r\n    if (fontStyleSheetElement) {\r\n      this.shadowRoot.host.appendChild(fontStyleSheetElement);\r\n    }\r\n    (hostStyleSheetElement || fontStyleSheetElement) &&\r\n      this.shadowRoot.host.setAttribute(WUJIE_DATA_ATTACH_CSS_FLAG, \"\");\r\n  }\r\n\r\n  /**\r\n   * @param id 子应用的id，唯一标识\r\n   * @param url 子应用的url，可以包含protocol、host、path、query、hash\r\n   */\r\n  constructor(options: {\r\n    name: string;\r\n    url: string;\r\n    attrs: { [key: string]: any };\r\n    degradeAttrs: { [key: string]: any };\r\n    fiber: boolean;\r\n    degrade;\r\n    plugins: Array<plugin>;\r\n    lifecycles: lifecycles;\r\n    mainHostPath?: string\r\n  }) {\r\n    // 传递inject给嵌套子应用\r\n    if (window.__POWERED_BY_WUJIE__) this.inject = window.__WUJIE.inject;\r\n    else {\r\n      this.inject = {\r\n        idToSandboxMap: idToSandboxCacheMap,\r\n        appEventObjMap,\r\n        mainHostPath: options.mainHostPath || window.location.protocol + \"//\" + window.location.host,\r\n      };\r\n    }\r\n    const { name, url, attrs, fiber, degradeAttrs, degrade, lifecycles, plugins } = options;\r\n    this.id = name;\r\n    this.fiber = fiber;\r\n    this.degrade = degrade || !wujieSupport;\r\n    this.bus = new EventBus(this.id);\r\n    this.url = url;\r\n    this.degradeAttrs = degradeAttrs;\r\n    this.provide = { bus: this.bus };\r\n    this.styleSheetElements = [];\r\n    this.execQueue = [];\r\n    this.lifecycles = lifecycles;\r\n    this.plugins = getPlugins(plugins);\r\n\r\n    // 创建目标地址的解析\r\n    const { urlElement, appHostPath, appRoutePath } = appRouteParse(url);\r\n    const { mainHostPath } = this.inject;\r\n    // 创建iframe\r\n    this.iframe = iframeGenerator(this, attrs, mainHostPath, appHostPath, appRoutePath);\r\n\r\n    if (this.degrade) {\r\n      const { proxyDocument, proxyLocation } = localGenerator(this.iframe, urlElement, mainHostPath, appHostPath);\r\n      this.proxyDocument = proxyDocument;\r\n      this.proxyLocation = proxyLocation;\r\n    } else {\r\n      const { proxyWindow, proxyDocument, proxyLocation } = proxyGenerator(\r\n        this.iframe,\r\n        urlElement,\r\n        mainHostPath,\r\n        appHostPath\r\n      );\r\n      this.proxy = proxyWindow;\r\n      this.proxyDocument = proxyDocument;\r\n      this.proxyLocation = proxyLocation;\r\n    }\r\n    this.provide.location = this.proxyLocation;\r\n\r\n    addSandboxCacheWithWujie(this.id, this);\r\n  }\r\n}\r\n"],"mappings":"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","ignoreList":[]}