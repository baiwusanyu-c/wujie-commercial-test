{"version":3,"file":"proxy.js","names":["patchElementEffect","renderIframeReplaceApp","renderElementToContainer","pushUrlToWindow","documentProxyProperties","rawDocumentQuerySelector","WUJIE_TIPS_RELOAD_DISABLED","WUJIE_TIPS_GET_ELEMENT_BY_ID","getTargetValue","anchorElementGenerator","getDegradeIframe","isCallable","checkProxyFunction","warn","stopMainAppRun","locationHrefSet","iframe","value","appHostPath","_iframe$contentWindow","contentWindow","__WUJIE","shadowRoot","id","degrade","document","degradeAttrs","url","test","hrefElement","pathname","search","hash","hrefFlag","iframeBody","call","contentDocument","documentElement","window","decodeURIComponent","parentElement","host","proxyGenerator","urlElement","mainHostPath","proxyWindow","Proxy","get","target","p","proxyLocation","Object","getOwnPropertyDescriptor","proxy","descriptor","configurable","writable","set","has","proxyDocument","_fakeDocument","propKey","_iframe$contentWindow2","rawCreateElement","__WUJIE_RAW_DOCUMENT_CREATE_ELEMENT__","rawCreateTextNode","__WUJIE_RAW_DOCUMENT_CREATE_TEXT_NODE__","apply","_createElement","_ctx","args","rawCreateMethod","element","href","querySelectorAll","arg","scripts","concat","res","error","querySelector","ctx","_ctx$propKey","__WUJIE_RAW_DOCUMENT_QUERY_SELECTOR__","rawPropMap","_ctx$propKey2","firstElementChild","ownerProperties","shadowProperties","shadowMethods","documentProperties","documentMethods","includes","toString","activeElement","body","_getTargetValue","_fakeLocation","location","replace","_args$","ownKeys","keys","filter","key","_target","enumerable","localGenerator","sandbox","defineProperties","createElement","_len","arguments","length","Array","_key","createTextNode","_len2","_key2","documentURI","URL","getElementsByTagName","tagName","undefined","modifyLocalProperties","modifyProperties","forEach","defineProperty","_sandbox$document","bind","locationKeys","constantKey","reload"],"sources":["../src/proxy.ts"],"sourcesContent":["import { patchElementEffect, renderIframeReplaceApp } from \"./iframe\";\r\nimport { renderElementToContainer } from \"./shadow\";\r\nimport { pushUrlToWindow } from \"./sync\";\r\nimport { documentProxyProperties, rawDocumentQuerySelector } from \"./common\";\r\nimport { WUJIE_TIPS_RELOAD_DISABLED, WUJIE_TIPS_GET_ELEMENT_BY_ID } from \"./constant\";\r\nimport {\r\n  getTargetValue,\r\n  anchorElementGenerator,\r\n  getDegradeIframe,\r\n  isCallable,\r\n  checkProxyFunction,\r\n  warn,\r\n  stopMainAppRun,\r\n} from \"./utils\";\r\n\r\n/**\r\n * location href 的set劫持操作\r\n */\r\nfunction locationHrefSet(iframe: HTMLIFrameElement, value: string, appHostPath: string): boolean {\r\n  const { shadowRoot, id, degrade, document, degradeAttrs } = iframe.contentWindow.__WUJIE;\r\n  let url = value;\r\n  if (!/^http/.test(url)) {\r\n    let hrefElement = anchorElementGenerator(url);\r\n    url = appHostPath + hrefElement.pathname + hrefElement.search + hrefElement.hash;\r\n    hrefElement = null;\r\n  }\r\n  iframe.contentWindow.__WUJIE.hrefFlag = true;\r\n  if (degrade) {\r\n    const iframeBody = rawDocumentQuerySelector.call(iframe.contentDocument, \"body\");\r\n    renderElementToContainer(document.documentElement, iframeBody);\r\n    renderIframeReplaceApp(window.decodeURIComponent(url), getDegradeIframe(id).parentElement, degradeAttrs);\r\n  } else renderIframeReplaceApp(url, shadowRoot.host.parentElement, degradeAttrs);\r\n  pushUrlToWindow(id, url);\r\n  return true;\r\n}\r\n\r\n/**\r\n * 非降级情况下window、document、location代理\r\n */\r\nexport function proxyGenerator(\r\n  iframe: HTMLIFrameElement,\r\n  urlElement: HTMLAnchorElement,\r\n  mainHostPath: string,\r\n  appHostPath: string\r\n): {\r\n  proxyWindow: Window;\r\n  proxyDocument: Object;\r\n  proxyLocation: Object;\r\n} {\r\n  const proxyWindow = new Proxy(iframe.contentWindow, {\r\n    get: (target: Window, p: PropertyKey): any => {\r\n      // location进行劫持\r\n      if (p === \"location\") {\r\n        return target.__WUJIE.proxyLocation;\r\n      }\r\n      // 判断自身\r\n      if (p === \"self\" || (p === \"window\" && Object.getOwnPropertyDescriptor(window, \"window\").get)) {\r\n        return target.__WUJIE.proxy;\r\n      }\r\n      // 不要绑定this\r\n      if (p === \"__WUJIE_RAW_DOCUMENT_QUERY_SELECTOR__\" || p === \"__WUJIE_RAW_DOCUMENT_QUERY_SELECTOR_ALL__\") {\r\n        return target[p];\r\n      }\r\n      // https://262.ecma-international.org/8.0/#sec-proxy-object-internal-methods-and-internal-slots-get-p-receiver\r\n      const descriptor = Object.getOwnPropertyDescriptor(target, p);\r\n      if (descriptor?.configurable === false && descriptor?.writable === false) {\r\n        return target[p];\r\n      }\r\n      // 修正this指针指向\r\n      return getTargetValue(target, p);\r\n    },\r\n\r\n    set: (target: Window, p: PropertyKey, value: any) => {\r\n      checkProxyFunction(value);\r\n      target[p] = value;\r\n      return true;\r\n    },\r\n\r\n    has: (target: Window, p: PropertyKey) => p in target,\r\n  });\r\n\r\n  // proxy document\r\n  const proxyDocument = new Proxy(\r\n    {},\r\n    {\r\n      get: function (_fakeDocument, propKey) {\r\n        const document = window.document;\r\n        const { shadowRoot, proxyLocation } = iframe.contentWindow.__WUJIE;\r\n        // iframe初始化完成后，webcomponent还未挂在上去，此时运行了主应用代码，必须中止\r\n        if (!shadowRoot) stopMainAppRun();\r\n        const rawCreateElement = iframe.contentWindow.__WUJIE_RAW_DOCUMENT_CREATE_ELEMENT__;\r\n        const rawCreateTextNode = iframe.contentWindow.__WUJIE_RAW_DOCUMENT_CREATE_TEXT_NODE__;\r\n        // need fix\r\n        if (propKey === \"createElement\" || propKey === \"createTextNode\") {\r\n          return new Proxy(document[propKey], {\r\n            apply(_createElement, _ctx, args) {\r\n              const rawCreateMethod = propKey === \"createElement\" ? rawCreateElement : rawCreateTextNode;\r\n              const element = rawCreateMethod.apply(iframe.contentDocument, args);\r\n              patchElementEffect(element, iframe.contentWindow);\r\n              return element;\r\n            },\r\n          });\r\n        }\r\n        if (propKey === \"documentURI\" || propKey === \"URL\") {\r\n          return (proxyLocation as Location).href;\r\n        }\r\n\r\n        // from shadowRoot\r\n        if (\r\n          propKey === \"getElementsByTagName\" ||\r\n          propKey === \"getElementsByClassName\" ||\r\n          propKey === \"getElementsByName\"\r\n        ) {\r\n          return new Proxy(shadowRoot.querySelectorAll, {\r\n            apply(querySelectorAll, _ctx, args) {\r\n              let arg = args[0];\r\n              if (_ctx !== iframe.contentDocument) {\r\n                return _ctx[propKey].apply(_ctx, args);\r\n              }\r\n\r\n              if (propKey === \"getElementsByTagName\" && arg === \"script\") {\r\n                return iframe.contentDocument.scripts;\r\n              }\r\n              if (propKey === \"getElementsByClassName\") arg = \".\" + arg;\r\n              if (propKey === \"getElementsByName\") arg = `[name=\"${arg}\"]`;\r\n\r\n              // FIXME: This string must be a valid CSS selector string; if it's not, a SyntaxError exception is thrown;\r\n              // so we should ensure that the program can execute normally in case of exceptions.\r\n              // reference: https://developer.mozilla.org/en-US/docs/Web/API/Document/querySelectorAll\r\n\r\n              let res: NodeList[] | [];\r\n              try {\r\n                res = querySelectorAll.call(shadowRoot, arg);\r\n              } catch (error) {\r\n                res = [];\r\n              }\r\n\r\n              return res;\r\n            },\r\n          });\r\n        }\r\n        if (propKey === \"getElementById\") {\r\n          return new Proxy(shadowRoot.querySelector, {\r\n            // case document.querySelector.call\r\n            apply(target, ctx, args) {\r\n              if (ctx !== iframe.contentDocument) {\r\n                return ctx[propKey]?.apply(ctx, args);\r\n              }\r\n              try {\r\n                return (\r\n                  target.call(shadowRoot, `[id=\"${args[0]}\"]`) ||\r\n                  iframe.contentWindow.__WUJIE_RAW_DOCUMENT_QUERY_SELECTOR__.call(\r\n                    iframe.contentWindow.document,\r\n                    `#${args[0]}`\r\n                  )\r\n                );\r\n              } catch (error) {\r\n                warn(WUJIE_TIPS_GET_ELEMENT_BY_ID);\r\n                return null;\r\n              }\r\n            },\r\n          });\r\n        }\r\n        if (propKey === \"querySelector\" || propKey === \"querySelectorAll\") {\r\n          const rawPropMap = {\r\n            querySelector: \"__WUJIE_RAW_DOCUMENT_QUERY_SELECTOR__\",\r\n            querySelectorAll: \"__WUJIE_RAW_DOCUMENT_QUERY_SELECTOR_ALL__\",\r\n          };\r\n          return new Proxy(shadowRoot[propKey], {\r\n            apply(target, ctx, args) {\r\n              if (ctx !== iframe.contentDocument) {\r\n                return ctx[propKey]?.apply(ctx, args);\r\n              }\r\n              // 二选一，优先shadowDom，除非采用array合并，排除base，防止对router造成影响\r\n              return (\r\n                target.apply(shadowRoot, args) ||\r\n                (args[0] === \"base\"\r\n                  ? null\r\n                  : iframe.contentWindow[rawPropMap[propKey]].call(iframe.contentWindow.document, args[0]))\r\n              );\r\n            },\r\n          });\r\n        }\r\n        if (propKey === \"documentElement\" || propKey === \"scrollingElement\") return shadowRoot.firstElementChild;\r\n        if (propKey === \"forms\") return shadowRoot.querySelectorAll(\"form\");\r\n        if (propKey === \"images\") return shadowRoot.querySelectorAll(\"img\");\r\n        if (propKey === \"links\") return shadowRoot.querySelectorAll(\"a\");\r\n        const { ownerProperties, shadowProperties, shadowMethods, documentProperties, documentMethods } =\r\n          documentProxyProperties;\r\n        if (ownerProperties.concat(shadowProperties).includes(propKey.toString())) {\r\n          if (propKey === \"activeElement\" && shadowRoot.activeElement === null) return shadowRoot.body;\r\n          return shadowRoot[propKey];\r\n        }\r\n        if (shadowMethods.includes(propKey.toString())) {\r\n          return getTargetValue(shadowRoot, propKey) ?? getTargetValue(document, propKey);\r\n        }\r\n        // from window.document\r\n        if (documentProperties.includes(propKey.toString())) {\r\n          return document[propKey];\r\n        }\r\n        if (documentMethods.includes(propKey.toString())) {\r\n          return getTargetValue(document, propKey);\r\n        }\r\n      },\r\n    }\r\n  );\r\n\r\n  // proxy location\r\n  const proxyLocation = new Proxy(\r\n    {},\r\n    {\r\n      get: function (_fakeLocation, propKey) {\r\n        const location = iframe.contentWindow.location;\r\n        if (\r\n          propKey === \"host\" ||\r\n          propKey === \"hostname\" ||\r\n          propKey === \"protocol\" ||\r\n          propKey === \"port\" ||\r\n          propKey === \"origin\"\r\n        ) {\r\n          return urlElement[propKey];\r\n        }\r\n        if (propKey === \"href\") {\r\n          return location[propKey].replace(mainHostPath, appHostPath);\r\n        }\r\n        if (propKey === \"reload\") {\r\n          warn(WUJIE_TIPS_RELOAD_DISABLED);\r\n          return () => null;\r\n        }\r\n        if (propKey === \"replace\") {\r\n          return new Proxy(location[propKey], {\r\n            apply(replace, _ctx, args) {\r\n              return replace.call(location, args[0]?.replace(appHostPath, mainHostPath));\r\n            },\r\n          });\r\n        }\r\n        return getTargetValue(location, propKey);\r\n      },\r\n      set: function (_fakeLocation, propKey, value) {\r\n        // 如果是跳转链接的话重开一个iframe\r\n        if (propKey === \"href\") {\r\n          return locationHrefSet(iframe, value, appHostPath);\r\n        }\r\n        iframe.contentWindow.location[propKey] = value;\r\n        return true;\r\n      },\r\n      ownKeys: function () {\r\n        return Object.keys(iframe.contentWindow.location).filter((key) => key !== \"reload\");\r\n      },\r\n      getOwnPropertyDescriptor: function (_target, key) {\r\n        return { enumerable: true, configurable: true, value: this[key] };\r\n      },\r\n    }\r\n  );\r\n  return { proxyWindow, proxyDocument, proxyLocation };\r\n}\r\n\r\n/**\r\n * 降级情况下document、location代理处理\r\n */\r\nexport function localGenerator(\r\n  iframe: HTMLIFrameElement,\r\n  urlElement: HTMLAnchorElement,\r\n  mainHostPath: string,\r\n  appHostPath: string\r\n): {\r\n  proxyDocument: Object;\r\n  proxyLocation: Object;\r\n} {\r\n  // 代理 document\r\n  const proxyDocument = {};\r\n  const sandbox = iframe.contentWindow.__WUJIE;\r\n  // 特殊处理\r\n  Object.defineProperties(proxyDocument, {\r\n    createElement: {\r\n      get: () => {\r\n        return function (...args) {\r\n          const element = iframe.contentWindow.__WUJIE_RAW_DOCUMENT_CREATE_ELEMENT__.apply(\r\n            iframe.contentDocument,\r\n            args\r\n          );\r\n          patchElementEffect(element, iframe.contentWindow);\r\n          return element;\r\n        };\r\n      },\r\n    },\r\n    createTextNode: {\r\n      get: () => {\r\n        return function (...args) {\r\n          const element = iframe.contentWindow.__WUJIE_RAW_DOCUMENT_CREATE_TEXT_NODE__.apply(\r\n            iframe.contentDocument,\r\n            args\r\n          );\r\n          patchElementEffect(element, iframe.contentWindow);\r\n          return element;\r\n        };\r\n      },\r\n    },\r\n    documentURI: {\r\n      get: () => (sandbox.proxyLocation as Location).href,\r\n    },\r\n    URL: {\r\n      get: () => (sandbox.proxyLocation as Location).href,\r\n    },\r\n    getElementsByTagName: {\r\n      get() {\r\n        return function (...args) {\r\n          const tagName = args[0];\r\n          if (tagName === \"script\") {\r\n            return iframe.contentDocument.scripts as any;\r\n          }\r\n          return sandbox.document.getElementsByTagName(tagName) as any;\r\n        };\r\n      },\r\n    },\r\n  });\r\n  // 普通处理\r\n  const {\r\n    modifyLocalProperties,\r\n    modifyProperties,\r\n    ownerProperties,\r\n    shadowProperties,\r\n    shadowMethods,\r\n    documentProperties,\r\n    documentMethods,\r\n  } = documentProxyProperties;\r\n  modifyProperties\r\n    .filter((key) => !modifyLocalProperties.includes(key))\r\n    .concat(ownerProperties, shadowProperties, shadowMethods, documentProperties, documentMethods)\r\n    .forEach((key) => {\r\n      Object.defineProperty(proxyDocument, key, {\r\n        get: () => {\r\n          const value = sandbox.document?.[key];\r\n          return isCallable(value) ? value.bind(sandbox.document) : value;\r\n        },\r\n      });\r\n    });\r\n\r\n  // 代理 location\r\n  const proxyLocation = {};\r\n  const location = iframe.contentWindow.location;\r\n  const locationKeys = Object.keys(location);\r\n  const constantKey = [\"host\", \"hostname\", \"port\", \"protocol\", \"port\"];\r\n  constantKey.forEach((key) => {\r\n    proxyLocation[key] = urlElement[key];\r\n  });\r\n  Object.defineProperties(proxyLocation, {\r\n    href: {\r\n      get: () => location.href.replace(mainHostPath, appHostPath),\r\n      set: (value) => {\r\n        locationHrefSet(iframe, value, appHostPath);\r\n      },\r\n    },\r\n    reload: {\r\n      get() {\r\n        warn(WUJIE_TIPS_RELOAD_DISABLED);\r\n        return () => null;\r\n      },\r\n    },\r\n  });\r\n  locationKeys\r\n    .filter((key) => !constantKey.concat([\"href\", \"reload\"]).includes(key))\r\n    .forEach((key) => {\r\n      Object.defineProperty(proxyLocation, key, {\r\n        get: () => (isCallable(location[key]) ? location[key].bind(location) : location[key]),\r\n      });\r\n    });\r\n  return { proxyDocument, proxyLocation };\r\n}\r\n"],"mappings":"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","ignoreList":[]}