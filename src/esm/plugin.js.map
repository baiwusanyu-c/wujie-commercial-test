{"version":3,"file":"plugin.js","names":["compose","getAbsolutePath","getCssLoader","_ref","plugins","replace","code","src","arguments","length","undefined","base","map","plugin","cssLoader","getJsLoader","_ref2","jsLoader","getPresetLoaders","loaderType","loaders","filter","res","reduce","preLoaders","curLoaders","concat","reverse","getEffectLoaders","isMatchUrl","url","effectLoaders","some","loader","test","cssRelativePathResolve","baseUrl","urlReg","_m","pre","post","absoluteUrl","defaultPlugin","cssBeforeLoaders","content","getPlugins","Array","isArray","_toConsumableArray"],"sources":["../src/plugin.ts"],"sourcesContent":["import { plugin, ScriptObjectLoader } from \"./index\";\r\nimport { StyleObject } from \"./template\";\r\nimport { compose, getAbsolutePath } from \"./utils\";\r\n\r\ninterface loaderOption {\r\n  plugins: Array<plugin>;\r\n  replace: (code: string) => string;\r\n}\r\n\r\n/**\r\n * 获取柯里化 cssLoader\r\n */\r\nexport function getCssLoader({ plugins, replace }: loaderOption) {\r\n  return (code: string, src: string = \"\", base: string): string =>\r\n    compose(plugins.map((plugin) => plugin.cssLoader))(replace ? replace(code) : code, src, base);\r\n}\r\n\r\n/**\r\n * 获取柯里化 jsLoader\r\n */\r\nexport function getJsLoader({ plugins, replace }: loaderOption) {\r\n  return (code: string, src: string = \"\", base: string): string =>\r\n    compose(plugins.map((plugin) => plugin.jsLoader))(replace ? replace(code) : code, src, base);\r\n}\r\n\r\n/**\r\n * 获取预置插件\r\n */\r\ntype presetLoadersType = \"cssBeforeLoaders\" | \"cssAfterLoaders\" | \"jsBeforeLoaders\" | \"jsAfterLoaders\";\r\nexport function getPresetLoaders(loaderType: presetLoadersType, plugins: Array<plugin>): plugin[presetLoadersType] {\r\n  const loaders: (StyleObject | ScriptObjectLoader)[][] = plugins\r\n    .map((plugin) => plugin[loaderType])\r\n    .filter((loaders) => loaders?.length);\r\n  const res = loaders.reduce((preLoaders, curLoaders) => preLoaders.concat(curLoaders), []);\r\n  return loaderType === \"cssBeforeLoaders\" ? res.reverse() : res;\r\n}\r\n\r\n/**\r\n * 获取影响插件\r\n */\r\ntype effectLoadersType = \"jsExcludes\" | \"cssExcludes\" | \"jsIgnores\" | \"cssIgnores\";\r\nexport function getEffectLoaders(loaderType: effectLoadersType, plugins: Array<plugin>): plugin[effectLoadersType] {\r\n  return plugins\r\n    .map((plugin) => plugin[loaderType])\r\n    .filter((loaders) => loaders?.length)\r\n    .reduce((preLoaders, curLoaders) => preLoaders.concat(curLoaders), []);\r\n}\r\n\r\n// 判断 url 是否符合loader的规则\r\nexport function isMatchUrl(url: string, effectLoaders: plugin[effectLoadersType]): boolean {\r\n  return effectLoaders.some((loader) => (typeof loader === \"string\" ? url === loader : loader.test(url)));\r\n}\r\n\r\n/**\r\n * 转换子应用css内的相对地址成绝对地址\r\n */\r\nfunction cssRelativePathResolve(code: string, src: string, base: string) {\r\n  const baseUrl = src ? getAbsolutePath(src, base) : base;\r\n  // https://developer.mozilla.org/en-US/docs/Web/CSS/url\r\n  const urlReg = /(url\\((?!['\"]?(?:data):)['\"]?)([^'\")]*)(['\"]?\\))/g;\r\n  return code.replace(urlReg, (_m, pre, url, post) => {\r\n    const absoluteUrl = getAbsolutePath(url, baseUrl);\r\n    return pre + absoluteUrl + post;\r\n  });\r\n}\r\n\r\nconst defaultPlugin = {\r\n  cssLoader: cssRelativePathResolve,\r\n  // fix https://github.com/Tencent/wujie/issues/455\r\n  cssBeforeLoaders: [{ content: \"html {view-transition-name: none;}\" }],\r\n};\r\n\r\nexport function getPlugins(plugins: Array<plugin>): Array<plugin> {\r\n  return Array.isArray(plugins) ? [defaultPlugin, ...plugins] : [defaultPlugin];\r\n}\r\n\r\nexport default defaultPlugin;\r\n"],"mappings":"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","ignoreList":[]}